#!/bin/bash

SSH_CONFIG=$HOME/.ssh/config

RAW_URL="https://raw.githubusercontent.com/awisu2/my_shell/master/myshells"
DOWNLOAD_PATH_SUDO="/usr/local/bin/myshells"
DOWNLOAD_PATH_USER="$HOME/myshells"

docker=`which docker`

echo_attention() {
  echo "=================================================="
  echo "$1"
  echo "=================================================="
}

echo_onlyshow() {
  echo_attention "only show"
}

cat_if_exists() {
  if [ -f "$1" ]; then
    echo "exists $1"
    cat $1
  fi
}

# ssh ==========
show_ssh_key_generate() {
  echo_onlyshow

  type="-t rsa"
  bit="-b 4096"
  comment="-C foo@bar.com"
  file="-f ~/.ssh/id_rsa"
  
  echo "ssh-keygen ${type} ${bit} ${comment} ${file}"
  echo ""
  echo "-C is comment. default format is {user@domain} it can delete if set \"\""
  echo ""

  echo "create public from secret"
  echo "ssh-keygen -y ${file} > ~/.ssh/id_rsa.pub"
  echo ""
}

show_ssh_config() {
  if [ ! -f "$SSH_CONFIG" ]; then
    echo "file not exists. $SSH_CONFIG"
    exit 0
  fi

  cat $SSH_CONFIG
}

show_ssh_config_hosts() {
  if [ ! -f "$SSH_CONFIG" ]; then
    echo "file not exists. $SSH_CONFIG"
    exit 0
  fi

  for i in `grep "^Host " $SSH_CONFIG | sed s/"^Host "// | grep -v "^\*$"`
  do
    echo "${i};"
  done
}

# os ==========
sudo_run() {
  echo "[sudo] $*"
  sudo $*
}

os_info() {
  echo "uname"
  uname -a
  echo ""

  echo "cat any os release file"
  cat_if_exists "/etc/redhat-release"
  cat_if_exists "/etc/fedora-release"
  cat_if_exists "/etc/debian_version "
  cat_if_exists "/etc/lsb-release"
  cat_if_exists "/etc/turbolinux-release"
  cat_if_exists "/etc/SuSE-release"
  echo ""

  echo "proc version"
  cat_if_exists "/proc/version"
}

os_usingports() {
  sudo_run lsof -i $*
}

self_update() {
  read -p "is able to use sudo? (y/n):" res
  if [ "$res" == "y" ]; then
    sudo_run "download to $DOWNLOAD_PATH_SUDO"
    sudo curl -o "$DOWNLOAD_PATH_SUDO" "$RAW_URL"
  else
    sudo_run "download to $DOWNLOAD_PATH_USER"
    curl -o "${DOWNLOAD_PATH_USER}" "$RAW_URL"
  fi
}

systemctl_run() {
  sudo_run systemctl $*
}

systemctl_status() {
  systemctl_run is-enabled $*
}

systemctl_start() {
  systemctl_run start $*
}

systemctl_stop() {
  systemctl_run stop $*
}

systemctl_autorun_start() {
  systemctl_run enable $*
}

systemctl_autorun_stop() {
  systemctl_run disable $*
}

# mysql ==========
mysql_run() {
  sudo service mysqld $*
}

mysql_status() {
  mysql_run status $*
}

mysql_start() {
  mysql_run start $*
}

mysql_stop() {
  mysql_run stop $*
}

# call commands ==========
cmd=$1
shift
case "$cmd" in
  ssh_key_generate)
    show_ssh_key_generate
    ;;
  ssh_config)
    show_ssh_config
    ;;
  ssh_config_hosts)
    show_ssh_config_hosts
    ;;
  os_info)
    os_info
    ;;
  os_usingports)
    os_usingports $*
    ;;
  self_update)
    self_update
    ;;
  mysql_status)
    mysql_status $*
    ;;
  mysql_start)
    mysql_start $*
    ;;
  mysql_stop)
    mysql_stop $*
    ;;
  mysql)
    mysql_run $*
    ;;
  systemctl_status)
    systemctl_status $*
    ;;
  systemctl_start)
    systemctl_start $*
    ;;
  systemctl_stop)
    systemctl_stop $*
    ;;
  systemctl_autorun_start)
    systemctl_stop $*
    ;;
  systemctl_autorun_stop)
    systemctl_stop $*
    ;;
  *)
    read -d '' help <<-EOF
Usage: $0 command

ssh:
  ssh_config show   ssh config
  ssh_config_hosts  show ssh config hosts
  ssh_key_generate  show ssh key generate sample
mysql(sudo):
  mysql_status mysql status
  mysql_start  mysql start
  mysql_stop   mysql stop
  mysql        mysql run
os:
  os_info                           check os infomation
  os_usingports(sudo)               check using ports
  systemctl_status {daemon}         systemctl status
  systemctl_start {daemon}          systemctl start
  systemctl_stop {daemon}           systemctl stop
  systemctl_autorun_start {daemon}  systemctl autorun start
  systemctl_autorun_stop {daemon}   systemctl autorun stop
self:
  self_update update this command
EOF
  echo "$help"
  exit 2
  ;;
esac